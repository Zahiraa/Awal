{% extends 'admin.html.twig' %}

{% block title %}Import de termes
{% endblock %}

{% block content %}
	<!-- Main Content -->
	<div
		class="flex-1 flex flex-col bg-gray-50">
		<!-- Header -->
		<header class="py-6 border-b border-gray-200">
			<div class="flex flex-wrap justify-between items-center gap-4">
				<div>
					<h1 class="text-2xl font-semibold text-gray-900">
						Import de termes depuis Excel
					</h1>
					<p class="text-gray-600 mt-1">
						Importez des termes en masse depuis un fichier Excel structuré.
					</p>
				</div>
				<a href="{{ path('app_admin_terme_index') }}" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg flex items-center hover:bg-gray-50 transition duration-200">
					Retour
				</a>
			</div>
		</header>

		<!-- Import Form -->
		<div class="py-8">
			<div class="bg-white rounded-lg shadow-sm overflow-hidden">
				<div class="p-6">
					<form id="importForm" method="post" enctype="multipart/form-data">
						<div
							class="space-y-4">
							<!-- File Input -->
							<div>
								<label for="excel_file" class="block text-sm font-medium text-gray-700 mb-2">
									Fichier Excel (.xlsx, .xls)
								</label>
								<input type="file" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 px-3 py-2" id="excel_file" name="excel_file" accept=".xlsx, .xls" required>
								<div class="mt-3">
									<a href="{{ asset('docs/SFIFA fichier import_export.xlsx') }}" download class="inline-flex items-center text-sm text-teal-600 hover:text-teal-700 font-medium transition duration-200">
										<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
										</svg>
										Télécharger le fichier d'exemple
									</a>
								</div>
							</div>

							<!-- Instructions -->
							<div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
								<h3 class="text-sm font-semibold text-blue-900 mb-2">
									Structure du fichier attendue:
								</h3>
								<ul class="text-sm text-blue-800 space-y-1 list-disc list-inside">
									<li>Ligne 1: Noms des catégories (chaque catégorie couvre 3 colonnes)</li>
									<li>Ligne 2: Noms des langues (Français, Arabe, Darija)</li>
									<li>Ligne 3+: Données des termes</li>
									<li>Si un terme existe déjà (même titre), il sera mis à jour</li>
								</ul>
							</div>

							<!-- Submit Button -->
							<div class="flex justify-end">
								<button type="submit" class="bg-teal-600 text-white px-6 py-2 rounded-lg hover:bg-teal-700 transition duration-200 flex items-center">
									<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
									</svg>
									Importer
								</button>
							</div>
						</div>
					</form>
				</div>
			</div>

			<!-- Result Section -->
			<div id="result" class="mt-6" style="display: none;">
				<div class="bg-white rounded-lg shadow-sm overflow-hidden">
					<div class="p-6">
						<h3 class="text-lg font-semibold text-gray-900 mb-4">Résultat de l'import</h3>
						<div id="resultContent"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		document.getElementById('importForm').addEventListener('submit', async function (e) {
e.preventDefault();

const formData = new FormData(this);
const resultDiv = document.getElementById('result');
const resultContent = document.getElementById('resultContent');
const submitButton = this.querySelector('button[type="submit"]');

// Désactiver le bouton pendant le traitement
submitButton.disabled = true;
submitButton.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Traitement...';

try {
const response = await fetch('{{ path('admin_import_terms') }}', {
method: 'POST',
body: formData
});

const data = await response.json();

if (data.success) {
const stats = data.stats;
let errorsHtml = '';

if (stats.errors > 0 && stats.errorMessages.length > 0) {
errorsHtml = `
							<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-4">
								<h4 class="text-sm font-semibold text-yellow-900 mb-2">Erreurs rencontrées:</h4>
								<ul class="text-xs text-yellow-800 list-disc list-inside space-y-1">
									${
stats.errorMessages.map(msg => `<li>${msg}</li>`).join('')
}
								</ul>
							</div>
						`;
}

resultContent.innerHTML = `
						<div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
							<div class="flex items-start">
								<svg class="w-5 h-5 text-green-600 mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
									<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
								</svg>
								<div class="flex-1">
									<h4 class="text-sm font-semibold text-green-900">Import terminé!</h4>
									<p class="text-sm text-green-800 mt-1">${
data.message
}</p>
								</div>
							</div>
						</div>
						${errorsHtml}
					`;
resultDiv.style.display = 'block';

// Scroll vers les résultats
resultDiv.scrollIntoView({behavior: 'smooth', block: 'start'});
} else {
resultContent.innerHTML = `
						<div class="bg-red-50 border border-red-200 rounded-lg p-4">
							<div class="flex items-start">
								<svg class="w-5 h-5 text-red-600 mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
									<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
								</svg>
								<div>
									<h4 class="text-sm font-semibold text-red-900">Erreur lors de l'import</h4>
									<p class="text-sm text-red-800 mt-1">${
data.error
}</p>
								</div>
							</div>
						</div>
					`;
resultDiv.style.display = 'block';
}
} catch (error) {
resultContent.innerHTML = `
					<div class="bg-red-50 border border-red-200 rounded-lg p-4">
						<div class="flex items-start">
							<svg class="w-5 h-5 text-red-600 mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
								<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
							</svg>
							<div>
								<h4 class="text-sm font-semibold text-red-900">Erreur de connexion</h4>
								<p class="text-sm text-red-800 mt-1">${
error.message
}</p>
							</div>
						</div>
					</div>
				`;
resultDiv.style.display = 'block';
} finally { // Réactiver le bouton
submitButton.disabled = false;
submitButton.innerHTML = `
					<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
					</svg>
					Importer
				`;
}
});
	</script>
{% endblock %}
