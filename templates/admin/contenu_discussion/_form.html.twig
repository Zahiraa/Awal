{{ form_start(form, {'attr': {'class': 'mx-auto p-6 bg-white rounded-lg shadow-sm'}}) }}

{% block head_scripts %}
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote-lite.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote-lite.min.js"></script>

	<script defer>
		const initSummernote = () => {
if (typeof $ === 'undefined') {
setTimeout(initSummernote, 100);
return;
}

const element = $('#contenu_discussion_content');
if (element.length === 0) {
setTimeout(initSummernote, 100);
return;
}

if (element.hasClass('note-editable')) {
element.summernote('destroy');
}
element.summernote({
height: 300,
tabsize: 2,
toolbar: [
[
'font',
[
'bold',
'underline',
'clear',
'italic',
'strikethrough'
]
],
[
'style', ['style']
],
[
'color', ['color']
],
[
'para',
[
'ul', 'ol', 'paragraph'
]
],
[
'table', ['table']
],
[
'insert',
[
'link', 'picture', 'video'
]
],
[
'view',
[
'codeview', 'help'
]
]
]
});
}

document.addEventListener('DOMContentLoaded', () => {
initSummernote();
});

// Re-initialize on turbo:load (for Turbo navigation)
document.addEventListener('turbo:load', () => {
initSummernote();
});
	</script>
{% endblock %}

{% set maxTaille = "5Mo" %}
{% set maxTailleMedia = "500Mo" %}

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
	{# ... image section ... #}
	<!-- Image Upload -->
		<div>
			<label class="flex-col flex items-center justify-center cursor-pointer pb-3 pt-3 px-4 border border-dashed border-gray-300 rounded-lg hover:bg-gray-50 transition" style="border: 1px solid #E3EDF2"> <img src="{{ asset('build/images/icons/upload.svg') }}" alt="Upload" width="40" height="40" class="mb-2">
			<p class="text-gray-600 text-center font-bold text-sm">
				<span class="text-pink-600">Cliquez pour télécharger une Image</span><br>
				SVG, PNG, JPG (max.
				{{ maxTaille }})
			</p>
			{{ form_row(form.image) }}
		</label>

		<div class="mt-4 rounded-2xl flex gap-4 justify-between p-2 border border-teal-500 bg-teal-50">
			{% if image is defined and image is not empty %}
				<img id="image-preview" src="{{ '/uploads/' ~ image.name }}" class="w-12 h-12 rounded-xl object-cover" alt="Preview">
				<div class="flex flex-col items-start justify-center flex-1 min-w-0">
					<p id="file-name" class="text-gray-600 font-bold text-xs truncate w-full">{{ image.name }}</p>
					<p id="file-size" class="text-gray-600 font-bold text-xs">Taille:
						{{ image.size ?? 'Inconnue' }}</p>
				</div>
				<img src="{{ asset('build/images/icons/valid.svg') }}" class="w-5 h-5" alt="Valid">
			{% else %}
				<img id="image-preview" src="{{ asset('build/images/icons/upload.svg') }}" class="w-12 h-12 rounded-xl object-contain opacity-50" alt="Preview">
				<div class="flex flex-col items-start justify-center flex-1 min-w-0">
					<p id="file-name" class="text-gray-600 font-bold text-xs">Aucune image</p>
					<p id="file-size" class="text-gray-600 font-bold text-xs">Taille: 0 KB</p>
				</div>
				<img id="img-valid" style="display: none" src="{{ asset('build/images/icons/valid.svg') }}" class="w-5 h-5" alt="Valid">
			{% endif %}
		</div>
	</div>

	<!-- Media Upload -->
	<div>
		<label class="flex-col flex items-center justify-center cursor-pointer pb-3 pt-3 px-4 border border-dashed border-gray-300 rounded-lg hover:bg-gray-50 transition" style="border: 1px solid #E3EDF2">
			<img src="{{ asset('build/images/icons/upload.svg') }}" alt="Upload" width="40" height="40" class="mb-2">
			<p class="text-gray-600 text-center font-bold text-sm">
				<span class="text-blue-600">Cliquez pour télécharger un Media</span><br>
				MP4, MP3, PDF (max.
				{{ maxTailleMedia }})
			</p>
			{{ form_row(form.media) }}
		</label>

		<div class="mt-4 rounded-2xl flex gap-4 justify-between p-2 border border-blue-500 bg-blue-50">
			{% if media is defined and media is not empty %}
				<div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
					<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
					</svg>
				</div>
				<div class="flex flex-col items-start justify-center flex-1 min-w-0">
					<p id="media-file-name" class="text-gray-600 font-bold text-xs truncate w-full">{{ media.name }}</p>
					<p id="media-file-size" class="text-gray-600 font-bold text-xs">Taille:
						{{ media.size ?? 'Inconnue' }}</p>
				</div>
				<img src="{{ asset('build/images/icons/valid.svg') }}" class="w-5 h-5" alt="Valid">
			{% else %}
				<div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center">
					<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
					</svg>
				</div>
				<div class="flex flex-col items-start justify-center flex-1 min-w-0">
					<p id="media-file-name" class="text-gray-600 font-bold text-xs">Aucun media</p>
					<p id="media-file-size" class="text-gray-600 font-bold text-xs">Taille: 0 KB</p>
				</div>
				<img id="media-valid" style="display: none" src="{{ asset('build/images/icons/valid.svg') }}" class="w-5 h-5" alt="Valid">
			{% endif %}
		</div>
	</div>
</div>

<div class="flex flex-col gap-4">
	{{ form_row(form.title, {'label': 'العنوان'}) }}
	{{ form_row(form.subTitle, {'label': 'العنوان الفرعي'}) }}
	{{ form_row(form.content, {'label': ' (اختياري) نص الحوار'}) }}
</div>

<div class="flex flex-col md:flex-row items-start md:items-center mt-6 border-t pt-4 border-gray-300 gap-4 md:gap-0">
	<div class="flex flex-col md:flex-row w-full md:w-auto md:ml-auto space-y-3 md:space-y-0 md:space-x-3 gap-1">
		<a href="{{ path('app_admin_contenu_discussion_index') }}" class="w-full md:w-auto bg-white border border-gray-300 px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 text-lg text-gray-700 hover:bg-gray-50">
			إلغاء
		</a>

		{% if form.children.draft_button is defined %}
			<button type="submit" name="{{ form.draft_button.vars.full_name }}" class="w-full md:w-auto {{ form.draft_button.vars.attr.class }} flex items-center justify-center">
				{{ form.draft_button.vars.label }}
				<svg width="18" height="18" viewbox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
					<path d="M4.83333 1.5V4.33333C4.83333 4.80004 4.83333 5.0334 4.92416 5.21166C5.00406 5.36846 5.13154 5.49594 5.28834 5.57584C5.4666 5.66667 5.69996 5.66667 6.16667 5.66667H11.8333C12.3 5.66667 12.5334 5.66667 12.7117 5.57584C12.8685 5.49594 12.9959 5.36846 13.0758 5.21166C13.1667 5.0334 13.1667 4.80004 13.1667 4.33333V2.33333M13.1667 16.5V11.1667C13.1667 10.7 13.1667 10.4666 13.0758 10.2883C12.9959 10.1315 12.8685 10.0041 12.7117 9.92416C12.5334 9.83333 12.3 9.83333 11.8333 9.83333H6.16667C5.69996 9.83333 5.4666 9.83333 5.28834 9.92416C5.13154 10.0041 5.00406 10.1315 4.92416 10.2883C4.83333 10.4666 4.83333 10.7 4.83333 11.1667V16.5M16.5 6.77124V12.5C16.5 13.9001 16.5 14.6002 16.2275 15.135C15.9878 15.6054 15.6054 15.9878 15.135 16.2275C14.6002 16.5 13.9001 16.5 12.5 16.5H5.5C4.09987 16.5 3.3998 16.5 2.86502 16.2275C2.39462 15.9878 2.01217 15.6054 1.77248 15.135C1.5 14.6002 1.5 13.9001 1.5 12.5V5.5C1.5 4.09987 1.5 3.3998 1.77248 2.86502C2.01217 2.39462 2.39462 2.01217 2.86502 1.77248C3.3998 1.5 4.09987 1.5 5.5 1.5H11.2288C11.6364 1.5 11.8402 1.5 12.0321 1.54605C12.2021 1.58688 12.3647 1.65422 12.5138 1.7456C12.682 1.84867 12.8261 1.9928 13.1144 2.28105L15.719 4.88562C16.0072 5.17387 16.1513 5.318 16.2544 5.48619C16.3458 5.63531 16.4131 5.79789 16.4539 5.96795C16.5 6.15976 16.5 6.36358 16.5 6.77124Z" stroke="#069490" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"></path>
				</svg>
			</button>
		{% endif %}

		{% if form.children.publish_button is defined %}
			<button type="submit" name="{{ form.publish_button.vars.full_name }}" class="w-full md:w-auto {{ form.publish_button.vars.attr.class }} flex items-center justify-center">
				{{ form.publish_button.vars.label }}
				<svg width="18" height="18" viewbox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
					<path d="M16.5 6.50001L16.5 1.50001M16.5 1.50001H11.5M16.5 1.50001L9 9M7.33333 1.5H5.5C4.09987 1.5 3.3998 1.5 2.86502 1.77248C2.39462 2.01217 2.01217 2.39462 1.77248 2.86502C3.3998 1.5 4.09987 1.5 5.5 1.5H11.2288C11.6364 1.5 11.8402 1.5 12.0321 1.54605C12.2021 1.58688 12.3647 1.65422 12.5138 1.7456C12.682 1.84867 12.8261 1.9928 13.1144 2.28105L15.719 4.88562C16.0072 5.17387 16.1513 5.318 16.2544 5.48619C16.3458 5.63531 16.4131 5.79789 16.4539 5.96795C16.5 6.15976 16.5 6.36358 16.5 6.77124Z" stroke="white" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"></path>
				</svg>
			</button>
		{% endif %}

		{# Final safety fallback #}
		{% if form.children.draft_button is not defined %}
			<button type="submit" name="contenu_discussion[draft_button]" class="bg-[#AAEFEF] text-[#069490] px-4 py-2 rounded-lg font-semibold flex items-center gap-2 text-lg hover:bg-[#8EDFDF] transition cursor-pointer">
				Brouillon
			</button>
			<button type="submit" name="contenu_discussion[publish_button]" class="bg-teal-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-teal-700 transition duration-200 font-semibold cursor-pointer flex gap-2">
				Publier
			</button>
		{% endif %}
	</div>
</div>

{{ form_row(form._token ) }}
{{ form_end(form, {'render_rest': false}) }}

<!-- Image Size Error Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
	<div class="relative top-1/4 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
		<div class="mt-3 text-center">
			<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
				<svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
				</svg>
			</div>
			<h3 class="text-lg leading-6 font-medium text-gray-900">حجم ملف الصورة كبير جداً</h3>
			<div class="mt-2 px-7 py-3">
				<p class="text-sm text-gray-500">ملف الصورة الذي اخترته يتجاوز الحد الأقصى المسموح به ({{ maxTaille }}).</p>
			</div>
			<div class="items-center px-4 py-3">
				<button id="close-modal-btn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
					حسناً
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Media Size Error Modal -->
<div id="mediaModal" class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
	<div class="relative top-1/4 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
		<div class="mt-3 text-center">
			<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
				<svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
				</svg>
			</div>
			<h3 class="text-lg leading-6 font-medium text-gray-900">حجم ملف الميديا كبير جداً</h3>
			<div class="mt-2 px-7 py-3">
				<p class="text-sm text-gray-500">ملف الميديا الذي اخترته يتجاوز الحد الأقصى المسموح به ({{ maxTailleMedia }}).</p>
			</div>
			<div class="items-center px-4 py-3">
				<button id="close-media-modal-btn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
					حسناً
				</button>
			</div>
		</div>
	</div>
</div>

<script>
	(function () {
const imageInput = document.getElementById('{{ form.image is defined ? form.image.vars.id : "" }}');
const imagePreview = document.getElementById('image-preview');
const imgValid = document.getElementById('img-valid');
const fileNameLabel = document.getElementById('file-name');
const fileSizeLabel = document.getElementById('file-size');

const mediaInput = document.getElementById('{{ form.media is defined ? form.media.vars.id : "" }}');
const mediaValid = document.getElementById('media-valid');
const mediaNameLabel = document.getElementById('media-file-name');
const mediaSizeLabel = document.getElementById('media-file-size');

const imageModal = document.getElementById('imageModal');
const mediaModal = document.getElementById('mediaModal');
const closeImgBtn = document.getElementById('close-modal-btn');
const closeMediaBtn = document.getElementById('close-media-modal-btn');

if (closeImgBtn) {
closeImgBtn.addEventListener('click', () => {
imageModal.classList.add('hidden');
});
}
if (closeMediaBtn) {
closeMediaBtn.addEventListener('click', () => {
mediaModal.classList.add('hidden');
});
}

function handleFile(file, type) {
const limitMB = (type === 'image') ? 5 : 500;
const sizeMB = file.size / (1024 * 1024);
const sizeDisplay = sizeMB > 1 ? sizeMB.toFixed(2) + ' MB' : (file.size / 1024).toFixed(2) + ' KB';

if (sizeMB > limitMB) {
if (type === 'image') {
imageModal.classList.remove('hidden');
} else {
mediaModal.classList.remove('hidden');
}
return false;
}

if (type === 'image') {
fileNameLabel.textContent = file.name;
fileSizeLabel.textContent = `Taille: ${sizeDisplay}`;
imgValid.style.display = 'block';

const reader = new FileReader();
reader.onload = (e) => {
imagePreview.src = e.target.result;
imagePreview.style.opacity = '1';
};
reader.readAsDataURL(file);
} else {
mediaNameLabel.textContent = file.name;
mediaSizeLabel.textContent = `Taille: ${sizeDisplay}`;
mediaValid.style.display = 'block';
}
return true;
}

if (imageInput) {
imageInput.addEventListener('change', (e) => {
if (e.target.files[0]) 
handleFile(e.target.files[0], 'image');



});
}

if (mediaInput) {
mediaInput.addEventListener('change', (e) => {
if (e.target.files[0]) 
handleFile(e.target.files[0], 'media');



});
}
})();
</script>
